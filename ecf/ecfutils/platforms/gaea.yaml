platform: !Platform
  Evaluate: false
  name: THEIA

  detect: !calc tools.isdir("/lustre/f1")

  public_release_ics: /lustre/f1/pdata/ncep_shared/FV3GFS_V1_RELEASE/ICs

  CHGRP_RSTPROD_COMMAND: "chgrp rstprod"
  NWPROD: "/scratch4/NCEPDEV/global/save/glopara/nwpara"
  DMPDIR: "/scratch4/NCEPDEV/global/noscrub/dump"
  RTMFIX: "/scratch4/NCEPDEV/da/save/Michael.Lueken/nwprod/lib/crtm/2.2.3/fix_update"
  BASE_SVN: "/scratch4/NCEPDEV/global/save/glopara/svn"

  config_base_extras: !expand |
    export NDATE="$NWPROD/util/exec/ndate"
    export NHOUR="$NWPROD/util/exec/nhour"
    export WGRIB="$NWPROD/util/exec/wgrib"
    export WGRIB2="$NWPROD/util/exec/wgrib2"
    export COPYGB="$NWPROD/util/exec/copygb"
    export COPYGB2="$NWPROD/util/exec/copygb2"
    export GRBINDEX="$NWPROD/util/exec/grbindex"
    export GRB2INDEX="$NWPROD/util/exec/grb2index"
    export GRBINDEX2="$NWPROD/util/exec/grb2index"
    export CNVGRIB="$NWPROD/util/exec/cnvgrib"
    export CNVGRIB21_GFS="$NWPROD/util/exec/cnvgrib"
    export POSTGRB2TBL="$NWPROD/util/exec/params_grib2_tbl_new"

  shared_accounting_ref:
    queue: !calc metasched.varref('QUEUESHARED')
    project: !calc metasched.varref('CPU_PROJECT')
    partition: !calc metasched.varref('COMPUTE_PARTITION')

  service_accounting_ref:
    queue: !calc metasched.varref('QUEUESERV')
    project: !calc metasched.varref('CPU_PROJECT')
    partition: !calc metasched.varref('SERVICE_PARTITION')

  exclusive_accounting_ref:
    queue: !calc metasched.varref('QUEUE')
    project: !calc metasched.varref('CPU_PROJECT')
    partition: !calc metasched.varref('COMPUTE_PARTITION')

  metasched_more: !expand |
    {metasched.defvar("QUEUE", doc.platform.exclusive_queue)}
    {metasched.defvar("QUEUESHARED", doc.platform.shared_queue)}
    {metasched.defvar("QUEUESERV", doc.platform.service_queue)}
    {metasched.defvar("CPU_PROJECT", doc.accounting.cpu_project)}
    {metasched.defvar("SERVICE_PARTITION", "es")}
    {metasched.defvar("COMPUTE_PARTITION", "c4")}

  shared_queue: batch
  service_queue: rdtn
  exclusive_queue: batch

  scheduler_settings: &scheduler_settings
    name: MoabAlps
    physical_cores_per_node: 24
    logical_cpus_per_core: 2
    hyperthreading_allowed: true
    indent_text: "  "
  parallelism_settings: &parallelism_settings
    <<: *scheduler_settings
    name: HydraIMPI
  node_type_settings: &node_type_settings
    <<: *scheduler_settings
    node_type: generic

  scheduler: !calc |
    tools.get_scheduler(scheduler_settings.name, scheduler_settings)
  parallelism: !calc |
    tools.get_parallelism(parallelism_settings.name, parallelism_settings)
  nodes: !calc |
    tools.node_tool_for(node_type_settings.node_type, node_type_settings)

  user_scrub_area: !FirstTrue
    - do: /lustre/f1
      when: !calc tools.can_write(do)
    - do: /lustre/f1/ncep
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.esrl.rocoto
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.bgrp-account
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.ccsp-users
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.cm3
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.cmip6
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.decp
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.esm2g
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.esm2m
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.fre_test
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.hrao
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.ogrp-account
      when: !calc tools.can_write(do)
    - do: /lustre/f1/oar.gfdl.ssam
      when: !calc tools.can_write(do)
    - otherwise: !error "Cannot find project area.  Please set manually."
  long_term_temp: !calc user_scrub_area
  short_term_temp: !calc user_scrub_area
  EXP_PARENT_DIR: !expand "{doc.user_places.PROJECT_DIR}/{tools.env('USER')}"
